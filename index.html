<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="dark light">
    <title>HubFest - Gest√£o de Eventos</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/investimentos.css">
    <link rel="manifest" href="/manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- √çcones Feather para um visual limpo e moderno -->
    <script src="https://unpkg.com/feather-icons"></script>

    <!-- Supabase Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/js/supabase-config.js"></script>
    <script>
        // KILL SERVICE WORKER: Previne erros de cache (ERR_FAILED)
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(regs => {
                for (let reg of regs) reg.unregister();
            });
        }

        // AUTH GATE: Verifica√ß√£o de Seguran√ßa
        (function () {
            const activeUser = localStorage.getItem('hubfest_active_user');
            const isLoginPage = window.location.pathname.includes('login');

            if (!activeUser && !isLoginPage) {
                // Redireciona para login se n√£o estiver logado e n√£o estiver na p√°gina de login
                window.location.href = '/login';
            } else if (activeUser && isLoginPage) {
                // Redireciona para o dashboard se j√° estiver logado e tentar acessar login
                window.location.href = '/';
            }
        })();
    </script>
</head>

<body>
    <div class="app-container">
        <!-- Sidebar Fixa -->
        <aside class="sidebar" id="app-sidebar">
            <div class="sidebar-header-mobile">
                <div class="logo">
                    <span class="logo-text" onclick="navTo('dashboard')">HubFest</span>
                </div>
                <button class="mobile-close-btn" onclick="toggleMobileMenu()">
                    <i data-feather="x"></i>
                </button>
            </div>

            <nav class="menu">
                <button class="menu-item active" data-target="dashboard">
                    <i data-feather="grid"></i>
                    <span>Dashboard</span>
                </button>
                <button class="menu-item" data-target="parties">
                    <i data-feather="calendar"></i>
                    <span>Festas</span>
                </button>
                <button class="menu-item" data-target="tasks">
                    <i data-feather="check-square"></i>
                    <span>Tarefas</span>
                </button>
                <button class="menu-item" data-target="investimentos">
                    <i data-feather="shopping-bag"></i>
                    <span>Investimentos</span>
                </button>
                <button class="menu-item" data-target="calendar">
                    <i data-feather="clock"></i>
                    <span>Calend√°rio</span>
                </button>
                <button class="menu-item" data-target="settings">
                    <i data-feather="settings"></i>
                    <span>Configura√ß√µes</span>
                </button>
            </nav>

            <div class="sidebar-footer">
                <div class="user-profile">
                    <div class="user-avatar" id="user-initials">U</div>
                    <div class="user-info">
                        <p class="user-name" id="user-display-name">Usu√°rio</p>
                        <p class="user-status">Online</p>
                    </div>
                </div>
                <button class="menu-item logout-btn" onclick="logoutUser()">
                    <i data-feather="log-out"></i>
                    <span>Sair</span>
                </button>
            </div>
        </aside>

        <!-- Barra Topo Mobile (Hamburger) -->
        <header class="mobile-top-bar">
            <div class="logo">
                <span class="logo-text">HubFest</span>
            </div>
            <div class="mobile-top-right">
                <div class="user-profile-mini">
                    <span id="user-display-name-mini"
                        style="font-size: 0.8rem; font-weight: 600; color: var(--accent);"></span>
                    <div class="user-avatar-mini" id="user-initials-mini">U</div>
                </div>
                <button class="hamburger-btn" onclick="toggleMobileMenu()">
                    <i data-feather="menu"></i>
                </button>
            </div>
        </header>

        <!-- √Årea de Conte√∫do Principal -->
        <main class="main-content">
            <!-- Se√ß√£o: Dashboard (REDESENHADA) -->
            <section id="dashboard" class="content-section active">
                <header class="section-header">
                    <h1 class="welcome-greeting" id="main-greeting">Ol√°, <span>HubFester</span>!</h1>
                    <p id="welcome-subtitle">O seu HubFest est√° pronto para os eventos de hoje.</p>
                </header>

                <!-- üìä CARDS DE INDICADORES -->
                <div class="dashboard-grid">
                    <div class="card indicator-card">
                        <span class="indicator-number" id="dash-finalizadas">0</span>
                        <span class="indicator-label">Festas Finalizadas</span>
                    </div>
                    <div class="card indicator-card">
                        <span class="indicator-number" id="dash-ativas">1</span>
                        <span class="indicator-label">Tarefas Ativas</span>
                    </div>
                    <div class="card indicator-card">
                        <span class="indicator-number" id="dash-confirmadas">0</span>
                        <span class="indicator-label">Festas Confirmadas</span>
                    </div>
                </div>

                <!-- üöÄ INICIO R√ÅPIDO -->
                <div style="margin-bottom: 2.5rem;">
                    <h3 class="section-title">üöÄ In√≠cio R√°pido</h3>
                    <div class="quick-actions-grid"
                        style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 1rem;">
                        <button class="quick-btn primary" onclick="navTo('parties')">
                            <i data-feather="plus-circle"></i>
                            Criar Nova Festa
                        </button>
                        <button class="quick-btn" onclick="navTo('calendar')">
                            <i data-feather="calendar"></i>
                            Ver Calend√°rio
                        </button>
                        <button class="quick-btn" onclick="navTo('tasks')">
                            <i data-feather="check-square"></i>
                            Ver Tarefas
                        </button>
                        <button class="quick-btn" onclick="generateTotalReport()">
                            <i data-feather="file-text"></i>
                            Relat√≥rio Geral
                        </button>
                    </div>
                </div>

                <!-- üìÖ PR√ìXIMAS FESTAS (FULL WIDTH) -->
                <div>
                    <h3 class="section-title">üìÖ Pr√≥ximas Festas</h3>
                    <div id="dashboard-preview-list">
                        <!-- Preenchido via JS -->
                    </div>
                </div>
            </section>

            <!-- Se√ß√£o: Festas -->
            <section id="parties" class="content-section">
                <header class="section-header">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <div>
                            <h1>Festas</h1>
                            <p>Gerencie todas as festas</p>
                        </div>
                        <button class="quick-btn primary" onclick="openPartyModal()">
                            <i data-feather="plus"></i>
                            Nova Festa
                        </button>
                    </div>

                    <div class="filter-toolbar">
                        <div class="search-box">
                            <i data-feather="search"></i>
                            <input type="text" id="party-search" placeholder="Buscar por nome, respons√°vel...">
                        </div>
                        <div class="filter-group">
                            <button class="filter-chip active" data-filter="all">Todas</button>
                            <button class="filter-chip" data-filter="confirmada">Confirmadas</button>
                            <button class="filter-chip" data-filter="pendente">Pendentes</button>
                            <button class="filter-chip" data-filter="finalizada">Finalizadas</button>
                        </div>
                    </div>
                </header>
                <div class="card-list" id="lista-festas">
                    <!-- Preenchido via JS -->
                </div>
            </section>

            <!-- Se√ß√£o: Tarefas -->
            <section id="tasks" class="content-section">
                <header class="section-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h1>Tarefas</h1>
                            <p>Checklist de organiza√ß√£o</p>
                        </div>
                        <button class="quick-btn primary" onclick="openTaskModal()">
                            <i data-feather="plus"></i>
                            Nova Tarefa
                        </button>
                    </div>
                </header>
                <div class="card-list" id="lista-tarefas">
                    <!-- Preenchido via JS -->
                </div>
            </section>

            <!-- Se√ß√£o: Investimentos -->
            <section id="investimentos" class="content-section">
                <header class="section-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h1>üí∞ Investimentos & Compras</h1>
                            <p>Lista de brinquedos e equipamentos para comprar</p>
                        </div>
                        <button class="quick-btn primary" onclick="openInvestimentoModal()">
                            <i data-feather="plus"></i>
                            Novo Item
                        </button>
                    </div>
                </header>

                <div class="investment-summary card" style="margin-bottom: 2rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h3 style="margin-bottom: 0.5rem;">Total Selecionado</h3>
                            <p style="color: var(--text-muted); font-size: 0.9rem;" id="selected-count">0 itens
                                selecionados</p>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 2.5rem; font-weight: 800; color: var(--accent);" id="total-value">R$
                                0,00</div>
                        </div>
                    </div>
                </div>

                <div class="investment-grid" id="lista-investimentos">
                    <!-- Preenchido via JS -->
                </div>
            </section>


            <!-- Se√ß√£o: Calend√°rio -->
            <section id="calendar" class="content-section">
                <header class="section-header">
                    <h1>Calend√°rio</h1>
                    <p>Visualize suas festas agendadas</p>
                </header>

                <div class="calendar-container">
                    <!-- Esquerda: Calend√°rio Mensal -->
                    <div class="card calendar-column-left">
                        <div class="calendar-header">
                            <button class="cal-nav-btn" id="prev-month">
                                <i data-feather="chevron-left"></i>
                            </button>
                            <h2 id="calendar-title">Janeiro 2026</h2>
                            <button class="cal-nav-btn" id="next-month">
                                <i data-feather="chevron-right"></i>
                            </button>
                        </div>

                        <div class="calendar-weekdays">
                            <span>Dom</span><span>Seg</span><span>Ter</span><span>Qua</span><span>Qui</span><span>Sex</span><span>S√°b</span>
                        </div>

                        <div class="calendar-grid" id="calendar-grid">
                            <!-- Dias gerados via JS -->
                        </div>
                    </div>

                    <!-- Direita: Detalhes do Dia -->
                    <div class="card calendar-column-right">
                        <div id="day-details-content">
                            <!-- Preenchido via JS -->
                            <div class="empty-day-state">
                                <h2 id="selected-date-title">Selecione uma data</h2>
                                <p>Nenhuma festa selecionada.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Se√ß√£o: Configura√ß√µes -->
            <section id="settings" class="content-section">
                <header class="section-header">
                    <h1>Configura√ß√µes</h1>
                    <p>Personalize seu HubFest</p>
                </header>
                <div class="card settings-card">
                    <h3>Visual & Tema</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 1rem;">Escolha como voc√™ quer ver o HubFest.
                    </p>
                    <div class="settings-actions">
                        <button class="btn-action" onclick="setTheme('dark')" id="btn-theme-dark">
                            <i data-feather="moon"></i>
                            Modo Escuro
                        </button>
                        <button class="btn-action" onclick="setTheme('light')" id="btn-theme-light">
                            <i data-feather="sun"></i>
                            Modo Claro
                        </button>
                    </div>
                </div>

                <div class="card settings-card" style="margin-top: 1.5rem;">
                    <h3>Personaliza√ß√£o do WhatsApp</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                        Edite o modelo da mensagem. Use as vari√°veis abaixo para substituir pelos dados da festa:
                        <br>
                        <code
                            style="color:var(--primary); background:rgba(255,255,255,0.1); padding:2px 4px; border-radius:4px;">[nome]</code>
                        <code
                            style="color:var(--primary); background:rgba(255,255,255,0.1); padding:2px 4px; border-radius:4px;">[responsavel]</code>
                        <code
                            style="color:var(--primary); background:rgba(255,255,255,0.1); padding:2px 4px; border-radius:4px;">[local]</code>
                        <code
                            style="color:var(--primary); background:rgba(255,255,255,0.1); padding:2px 4px; border-radius:4px;">[data]</code>
                        <code
                            style="color:var(--primary); background:rgba(255,255,255,0.1); padding:2px 4px; border-radius:4px;">[hora]</code>
                    </p>
                    <div class="form-group">
                        <label>Modelo da Mensagem</label>
                        <textarea id="config-template" rows="12" style="font-family: monospace; line-height: 1.5;"
                            oninput="savePreferences()"></textarea>
                    </div>
                    <div class="settings-actions">
                        <button class="btn-action" onclick="resetTemplate()">
                            <i data-feather="refresh-cw"></i>
                            Restaurar Modelo Padr√£o
                        </button>
                    </div>
                </div>

                <div class="card settings-card" style="margin-top: 1.5rem;">
                    <h3>Backup & Seguran√ßa</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 1rem;">Salve seus dados ou restaure de um
                        arquivo.</p>
                    <div class="settings-actions">
                        <button class="btn-action primary" onclick="exportAppData()">
                            <i data-feather="download"></i>
                            Exportar Backup
                        </button>
                        <button class="btn-action" onclick="triggerImport()">
                            <i data-feather="upload"></i>
                            Restaurar Backup
                        </button>
                        <!-- Hidden Input for File Upload -->
                        <input type="file" id="import-file" style="display: none;" accept=".json"
                            onchange="importAppData(this)">
                    </div>
                </div>

                <div class="card settings-card" style="margin-top: 1.5rem;">
                    <h3>Gerenciamento de Dados</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 1rem;">Controle os dados salvos localmente no
                        seu navegador.</p>
                    <div class="settings-actions">
                        <button class="btn-action" onclick="reloadDemoData()">
                            <i data-feather="refresh-cw"></i>
                            Recarregar Dados de Exemplo
                        </button>
                        <button class="btn-action danger" onclick="resetAppData()">
                            <i data-feather="trash-2"></i>
                            Limpar Tudo (Reset)
                        </button>
                    </div>
                </div>

                <div class="card settings-card" style="margin-top: 1.5rem;">
                    <h3>Sobre</h3>
                    <p><strong>HubFest</strong> v1.0.0</p>
                    <p style="color: var(--text-muted); font-size: 0.9rem; margin-top: 0.5rem;">
                        Sistema de gest√£o de festas infantis.<br>
                        Desenvolvido com tecnologia web moderna.
                    </p>
                </div>
            </section>
        </main>
    </div>

    <!-- MODAL OVERLAY -->
    <div id="modal-overlay" class="modal-overlay">
        <!-- MODAL FESTA -->
        <div id="modal-festa" class="modal-card">
            <h2 id="modal-festa-title">Nova Festa</h2>
            <form id="form-festa">
                <input type="hidden" id="festa-id">

                <div class="form-group">
                    <label>Nome da Crian√ßa/Festa</label>
                    <input type="text" id="festa-nome" required placeholder="Ex: Julia">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Respons√°vel</label>
                        <input type="text" id="festa-responsavel" placeholder="Ex: Thais">
                    </div>
                    <div class="form-group">
                        <label>Telefone</label>
                        <input type="tel" id="festa-telefone" placeholder="(21) 99999-9999">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Data</label>
                        <input type="date" id="festa-data" required>
                    </div>
                    <div class="form-group">
                        <label>Hora</label>
                        <input type="time" id="festa-hora" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Status</label>
                        <select id="festa-status">
                            <option value="neutral">Pendente</option>
                            <option value="warning">Planejamento</option>
                            <option value="success">Confirmada</option>
                            <option value="dark">Finalizada</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Idade (anos)</label>
                        <input type="number" id="festa-idade" placeholder="Ex: 3">
                    </div>
                    <div class="form-group">
                        <label>Qtd. Crian√ßas</label>
                        <input type="number" id="festa-criancas" placeholder="Ex: 20">
                    </div>
                </div>

                <div class="form-group">
                    <label>Local da Festa</label>
                    <input type="text" id="festa-local" placeholder="Ex: Av. Paulista, 1000 - Sal√£o de Festas">
                </div>

                <div class="form-group">
                    <label>Observa√ß√£o</label>
                    <textarea id="festa-obs" rows="3" placeholder="Detalhes importantes..."></textarea>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn-cancel" onclick="closeModals()">Cancelar</button>
                    <button type="submit" class="btn-submit">Salvar Festa</button>
                </div>
            </form>
        </div>

        <!-- MODAL TAREFA -->
        <div id="modal-tarefa" class="modal-card">
            <h2 id="modal-tarefa-title">Nova Tarefa</h2>
            <form id="form-tarefa">
                <input type="hidden" id="tarefa-id">

                <div class="form-group">
                    <label>T√≠tulo da Tarefa</label>
                    <input type="text" id="tarefa-titulo" required placeholder="Ex: Comprar descart√°veis">
                </div>

                <!-- Opcional: Vincular a uma festa (Futuro) -->

                <div class="form-actions">
                    <button type="button" class="btn-cancel" onclick="closeModals()">Cancelar</button>
                    <button type="submit" class="btn-submit">Salvar Tarefa</button>
                </div>
            </form>
        </div>

        <!-- MODAL INVESTIMENTO -->
        <div id="modal-investimento" class="modal-card">
            <h2 id="modal-investimento-title">Novo Investimento</h2>
            <form id="form-investimento">
                <input type="hidden" id="investimento-id">

                <div class="form-group">
                    <label>Foto do Item</label>
                    <input type="file" id="investimento-foto" accept="image/*" onchange="previewImage(this)">
                    <div id="image-preview" style="margin-top: 1rem; display: none;">
                        <img id="preview-img"
                            style="max-width: 200px; border-radius: 12px; border: 2px solid var(--border-color);">
                    </div>
                </div>

                <div class="form-group">
                    <label>Nome do Item</label>
                    <input type="text" id="investimento-nome" required placeholder="Ex: Piscina de Bolinhas">
                </div>

                <div class="form-group">
                    <label>Valor (R$)</label>
                    <input type="number" id="investimento-valor" step="0.01" required placeholder="Ex: 350.00">
                </div>

                <div class="form-group">
                    <label>Observa√ß√µes</label>
                    <textarea id="investimento-obs" rows="2" placeholder="Detalhes opcionais..."></textarea>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn-cancel" onclick="closeModals()">Cancelar</button>
                    <button type="submit" class="btn-submit">Salvar Item</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Scripts -->
    <script src="/js/data.js"></script>
    <script src="/js/investimentos.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/script.js"></script>
    <script>
        // Inicializa os √≠cones do Feather
        feather.replace();

        // Carregar dados do usu√°rio logado
        document.addEventListener('DOMContentLoaded', () => {
            const userStr = localStorage.getItem('hubfest_active_user');
            if (userStr) {
                const user = JSON.parse(userStr);
                const initials = user.name.charAt(0).toUpperCase();

                // Sidebar / Principal
                document.getElementById('user-display-name').innerText = user.name;
                document.getElementById('user-initials').innerText = initials;

                // Mini Profile (Mobile Header)
                const miniName = document.getElementById('user-display-name-mini');
                const miniInitials = document.getElementById('user-initials-mini');
                if (miniName) miniName.innerText = user.name.split(' ')[0]; // S√≥ primeiro nome no mini
                if (miniInitials) miniInitials.innerText = initials;

                // Personalizar sauda√ß√£o principal
                const greetingEl = document.getElementById('main-greeting');
                if (greetingEl) {
                    greetingEl.innerHTML = `Ol√°, <span>${user.name}</span>! ‚ú®`;
                }
                const subtitleEl = document.getElementById('welcome-subtitle');
                if (subtitleEl) {
                    const saudacoes = [
                        "Que dia incr√≠vel para organizar festas!",
                        "Tudo pronto para o HubFest de hoje?",
                        "Seu projeto est√° ficando fant√°stico!",
                        "Pronta para fazer a m√°gica acontecer?",
                        "Vamos organizar sonhos hoje?"
                    ];
                    subtitleEl.innerText = saudacoes[Math.floor(Math.random() * saudacoes.length)];
                }
            }
            const investBtn = document.querySelector('.menu-item[data-target="investimentos"]');
            if (investBtn) {
                investBtn.addEventListener('click', () => {
                    setTimeout(() => renderInvestimentos(), 100);
                });
            }
        });
    </script>
</body>

</html>